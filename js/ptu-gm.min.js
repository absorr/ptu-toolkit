var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(b,a,c){b instanceof String&&(b=String(b));for(var d=b.length,e=0;e<d;e++){var f=b[e];if(a.call(c,f,e,b))return{i:e,v:f}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(b,a,c){b!=Array.prototype&&b!=Object.prototype&&(b[a]=c.value)};
$jscomp.getGlobal=function(b){return"undefined"!=typeof window&&window===b?b:"undefined"!=typeof global&&null!=global?global:b};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(b,a,c,d){if(a){c=$jscomp.global;b=b.split(".");for(d=0;d<b.length-1;d++){var e=b[d];e in c||(c[e]={});c=c[e]}b=b[b.length-1];d=c[b];a=a(d);a!=d&&null!=a&&$jscomp.defineProperty(c,b,{configurable:!0,writable:!0,value:a})}};
$jscomp.polyfill("Array.prototype.find",function(b){return b?b:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");
var host_id=null,client_id="",campaign_id=34,DBG_MODE=0,peer=new Peer({key:"0ecbb01z4hkc5wmi",debug:3}),EXP_CHART=[0,10,20,30,40,50,60,70,80,90,110,135,160,190,220,250,285,320,260,400,460,530,600,670,745,820,900,990,1075,1165,1260,1355,1455,1555,1660,1770,1880,1995,2110,2230,2355,2480,2610,2740,2875,3015,3155,3300,3445,3645,3850,4060,4270,4485,4705,4930,5160,5390,5625,5865,6110,6360,6610,6868,7125,7390,7660,7925,8205,8485,8770,9060];peer.on("open",function(b){client_id=b});peer.on("error",function(b){console.log(b)});
$(function(){$.material.init();$('[data-toggle="tooltip"]').tooltip()});function receiveMessages(b,a){b.on("data",function(c){a(b,c)})}
function sendMessage(b,a){var c=peer.connections[b][0];peer.disconnected&&peer.reconnect();if(null!==c&&!c.open){if(1<peer.connections[b].length)for(var d=0;d<peer.connections[b].length;d++)peer.connections[b][d].open?c=peer.connections[b][d]:peer.connections[b].splice(d,1);if(!c.open){doToast("Connection to peer lost. Attempting to communicate");c=null;var e=peer.connect(b,{label:"chat",serialization:"none",metadata:{message:"connect to host"}});e.on("open",function(){doToast("Connection to peer found");
e.send(a)});e.on("error",function(a){alert(a)})}}null!==c&&c.send(a)}function sendMessageToAll(b){$.each(peer.connections,function(a,c){for(a=0;a<c.length;a++)c[a].send(b)})}
function rollDamageBase(b,a){switch(b){case 1:return roll(1*a,6,1)+1*a;case 2:return roll(1*a,6,1)+3*a;case 3:return roll(1*a,6,1)+5*a;case 4:return roll(1*a,8,1)+6*a;case 5:return roll(1*a,8,1)+8*a;case 6:return roll(2*a,6,1)+8*a;case 7:return roll(2*a,6,1)+10*a;case 8:return roll(2*a,8,1)+10*a;case 9:return roll(2*a,10,1)+10*a;case 10:return roll(3*a,8,1)+10*a;case 11:return roll(3*a,10,1)+10*a;case 12:return roll(3*a,12,1)+10*a;case 13:return roll(4*a,10,1)+10*a;case 14:return roll(4*a,10,1)+15*
a;case 15:return roll(4*a,10,1)+20*a;case 16:return roll(5*a,10,1)+20*a;case 17:return roll(5*a,12,1)+25*a;case 18:return roll(6*a,12,1)+25*a;case 19:return roll(6*a,12,1)+30*a;case 20:return roll(6*a,12,1)+35*a;case 21:return roll(6*a,12,1)+40*a;case 22:return roll(6*a,12,1)+45*a;case 23:return roll(6*a,12,1)+50*a;case 24:return roll(6*a,12,1)+55*a;case 25:return roll(6*a,12,1)+60*a;case 26:return roll(7*a,12,1)+65*a;case 27:return roll(8*a,12,1)+70*a;case 28:return roll(8*a,12,1)+80*a;default:return 0}}
function roll(b,a,c){for(var d=0,e=0;e<b;e++)d+=Math.floor(Math.random()*(a+1))*c;console.log("rolled "+d+" on d"+a);return d}function getStageMultiplier(b){switch(b){case -6:return.4;case -5:return.5;case -4:return.6;case -3:return.7;case -2:return.8;case -1:return.9;case 0:return 1;case 1:return 1.2;case 2:return 1.4;case 3:return 1.6;case 4:return 1.8;case 5:return 2;case 6:return 2.2;default:return 1}}function doToast(b){$.snackbar({content:b,style:"snackbar",timeout:6E3})}
$(function(){0<$("[data-populate='type']").length&&$.getJSON("api/v1/types",function(b){var a="";$.each(b,function(b,d){a+="<option>"+b.charAt(0).toUpperCase()+b.slice(1)+"</option>"});$("select[data-populate='type']").each(function(){$(this).html($(this).html()+a);$(this).removeAttr("data-populate")})});0<$("[data-populate='nature']").length&&$.getJSON("api/v1/natures",function(b){var a="";$.each(b,function(b,d){a+="<option>"+b+"</option>"});$("select[data-populate='nature']").each(function(){$(this).html($(this).html()+
a);$(this).removeAttr("data-populate")})});0<$("[data-populate='move']").length&&$.getJSON("api/v1/moves",function(b){var a="";$.each(b,function(b,d){a+="<option>"+b+"</option>"});$("select[data-populate='move']").each(function(){$(this).html($(this).html()+a);$(this).removeAttr("data-populate")})});0<$("[data-populate='ability']").length&&$.getJSON("api/v1/abilities",function(b){var a="";$.each(b,function(b,d){a+="<option>"+b+"</option>"});$("select[data-populate='ability']").each(function(){$(this).html($(this).html()+
a);$(this).removeAttr("data-populate")})});0<$("[data-populate='dex']").length&&fetchPokemon(0,50)});var mon_list=[];function fetchPokemon(b,a){$.getJSON("api/v1/pokemon/?offset="+b+"&size="+a,function(c){$.isEmptyObject(c)?$("[data-populate='dex']").autocomplete({source:mon_list}).focus(function(){var a=""===$(this).val()?" ":$(this).val();$(this).autocomplete("search",a)}):($.each(c,function(a,b){mon_list.push({label:a+" - "+b.Species,value:a})}),fetchPokemon(b+a,a))})}
function typeColor(b){var a="#000";switch(b.toLowerCase()){case "bug":a="rgb(158, 173, 30)";break;case "dark":a="rgb(99, 78, 64)";break;case "dragon":a="rgb(94, 33, 243)";break;case "electric":a="rgb(244, 200, 26)";break;case "fairy":a="rgb(223, 116, 223)";break;case "fighting":a="rgb(179, 44, 37)";break;case "fire":a="rgb(232, 118, 36)";break;case "flying":a="rgb(156, 136, 218,)";break;case "ghost":a="rgb(98, 77, 134)";break;case "grass":a="rgb(112, 191, 72)";break;case "ground":a="rgb(217, 178, 71)";
break;case "ice":a="rgb(130, 208, 208)";break;case "normal":a="rgb(158, 158, 109)";break;case "poison":a="rgb(149, 59, 149)";break;case "psychic":a="rgb(247, 64, 119)";break;case "rock":a="rgb(169, 147, 51)";break;case "steel":a="rgb(166, 166, 196)";break;case "water":a="rgb(82, 127, 238)"}return a};function changeView(b,a){currentView=b;0===b?($("#body-battle").removeClass("hidden"),$("#body-pokemon").addClass("hidden"),$("#body-settings").addClass("hidden"),a||BattlerView.render()):1===b?($("#body-battle").addClass("hidden"),$("#body-pokemon").removeClass("hidden"),$("#body-settings").addClass("hidden"),a||renderPokemonList()):2===b&&($("#body-battle").addClass("hidden"),$("#body-pokemon").addClass("hidden"),$("#body-settings").removeClass("hidden"))}
var config={apiKey:"AIzaSyBGYQmctNWkQWpII2cfqs9yBJOEwgKvKAM",authDomain:"ptu-toolkit.firebaseapp.com",databaseURL:"https://ptu-toolkit.firebaseio.com",projectId:"ptu-toolkit",storageBucket:"ptu-toolkit.appspot.com",messagingSenderId:"412564537560"};firebase.initializeApp(config);var f_token;
firebase.auth().onAuthStateChanged(function(b){b&&firebase.auth().currentUser.getToken(!0).then(function(a){f_token=a;$.ajax({type:"GET",url:"api/v1/campaign",dataType:"json",async:!1,beforeSend:function(c){c.setRequestHeader("Authorization","Basic "+btoa(b.uid+":"+a))},success:function(a,b,e){},error:function(a,b,e){window.alert(b+" "+e)}})}).catch(function(a){window.alert(a)})},function(b){console.log(b)});
function changeGMView(b){currentView=b;0===b?($("#body-battle").removeClass("hidden"),$("#body-pokemon").addClass("hidden"),$("#body-settings").addClass("hidden"),BattlerView.render()):1===b?($("#body-battle").addClass("hidden"),$("#body-pokemon").removeClass("hidden"),$("#body-settings").addClass("hidden"),renderPokemonList()):2===b&&($("#body-battle").addClass("hidden"),$("#body-pokemon").addClass("hidden"),$("#body-settings").removeClass("hidden"))}
var DataHelperBase=function(){return{onDataLoaded:function(){$("#display-gmid").html(client_id);$(".content-select").css("display","none");$(".footer-gm").removeClass("hidden");$("#link-sharable").val("http://ptu.will-step.com/?host="+client_id);new Clipboard(".btn");$("#zoom-slider").noUiSlider({start:[10],step:1,connect:!1,range:{min:1,max:20}}).on("change",function(){BattlerView.render()});$("#view-holder").addClass("hidden");changeGMView(0)}}}();var AfflictionEnum={Burned:"BURNED",Frozen:"FROZEN",Paralysis:"PARALYSIS",Poisoned:"POISONED",Fainted:"FAINTED",Confused:"CONFUSED"},AfflictionHelper={hasAffliction:function(b,a){return!1},addAffliction:function(b,a,c){a&&"object"!==$.type(a)&&(a=getJSONNonAsync("api/v1/data/character/"+a));b=b.toUpperCase();this.typeHasImmunity(a.Type1,b)||a.Type2&&this.typeHasImmunity(a.Type2,b)||2===DBG_MODE||$.post("api/v1/data/character/affliction",{character_id:a.CharacterId,affliction:b,method:"ADD"},function(c){b===
AfflictionEnum.Burned?(CharacterHelper.modifyCombatStage(a.CharacterId,"def",-2),doToast(a.Name+" is being burned!")):b===AfflictionEnum.Frozen?doToast(a.Name+" is frozen solid!"):b===AfflictionEnum.Paralysis?doToast(a.Name+" has been paralyzed!"):b===AfflictionEnum.Poisoned?(CharacterHelper.modifyCombatStage(a.CharacterId,"spdef",-2),doToast(a.Name+" has been poisoned!")):b===AfflictionEnum.Confused&&doToast(a.Name+" is confused!");connections[a.CharacterId]&&sendMessage(connections[a.CharacterId].client_id,
JSON.stringify({type:"afflict_add",affliction:b}));0===currentView&&BattlerView.render()})},deleteAffliction:function(b,a){b=b.toUpperCase();"BURNED"==b||"FROZEN"==b||"PARALYSIS"==b||"POISONED"==b?(gm_data.entities[a].tags.push(b).splice(array.indexOf(b),1),"BURNED"==b?(modifyCombatStage(a,"def",2),doToast(gm_data.entities[a].name+" was cured of their burn")):"FROZEN"==b?doToast(gm_data.entities[a].name+" was cured of Frozen"):"PARALYSIS"==b?doToast(gm_data.entities[a].name+" was cured of Paralysis"):
"POISONED"==b&&(modifyCombatStage(a,"spdef",2),doToast(gm_data.entities[a].name+" was cured of Poison"))):(gm_data.entities[a].battle_tags.push(b).splice(array.indexOf(b),1),doToast(gm_data.entities[a].name+" was cured of "+b));sendMessage(connections[a],JSON.stringify({type:"afflict_delete",affliction:b}));0==currentView&&BattlerView.render()},handleAffliction:function(b,a){if("Burned"==b||"Poisoned"==b){var c=gm_data.pokemon[a].level+3*gm_data.pokemon[a].hp+10;gm_data.pokemon[a].health-=Math.floor(.1*
c);"Burned"==b?doToast(gm_data.pokemon[a].name+" was damaged by their burn"):"Poisoned"==b&&doToast(gm_data.pokemon[a].name+" was damaged from poison");0>=gm_data.pokemon[a].health&&(doToast(gm_data.pokemon[a].name+" fainted!"),gm_data.pokemon[a].health=0);b=Math.floor(gm_data.pokemon[a].health/c*100);$("[data-name='"+a+"']").find(".progress-bar").css("width",b+"%");sendMessage(battle[a].client_id,JSON.stringify({type:"health",value:gm_data.pokemon[a].health}))}else{if("Frozen"==b)return b=roll(1,
20,1),16<=b||11<=b&&("Fire"==gm_data.pokemon[a].type||0<=$.inArray("Fire",gm_data.pokemon[a].type.split(" / ")))?(deleteAffliction("Frozen",a),!0):!1;if("Confused"==b){b=roll(1,20,1);if(8>=b)return doPhysicalStruggle(a),doToast(gm_data.pokemon[a].name+" hurt itself in confusion!"),!1;16<=b&&deleteAffliction("Confused",a)}}return!0},typeHasImmunity:function(b,a){a=a.toUpperCase();b=b.toUpperCase();return a===AfflictionEnum.Burned&&"FIRE"===b||a===AfflictionEnum.Frozen&&("FIRE"===b||"ICE"===b)||a===
AfflictionEnum.Paralysis&&"ELECTRIC"===b||a===AfflictionEnum.Poisoned&&("POISON"===b||"STEEL"===b)}};var connections={},previous_moves=[],in_battle=[],CurrentAction={dealer:{CharacterId:2,CampaignId:34,Type:"POKEMON",PokedexNo:"374",PokedexId:1,Name:"Siri",Owner:13,Age:null,Weight:null,Height:null,Sex:"Genderless",Type1:"Steel",Type2:"Psychic",Level:9,Exp:87,BaseHp:4,BaseAtk:6,BaseDef:8,BaseSatk:4,BaseSdef:6,BaseSpd:3,LvlUpHp:1,LvlUpAtk:5,LvlUpDef:0,LvlUpSatk:3,LvlUpSdef:7,LvlUpSpd:1,AddHp:0,AddAtk:1,AddDef:0,AddSatk:-1,AddSdef:0,AddSpd:0,Health:34,Injuries:0,Money:0,SkillAcrobatics:2,SkillAthletics:2,
SkillCharm:2,SkillCombat:2,SkillCommand:2,SkillGeneralEd:2,SkillMedicineEd:2,SkillOccultEd:2,SkillPokemonEd:2,SkillTechnologyEd:2,SkillFocus:2,SkillGuile:2,SkillIntimidate:2,SkillIntuition:2,SkillPerception:2,SkillStealth:2,SkillSurvival:2,ApSpent:0,ApBound:0,ApDrained:0,BackgroundName:null,BackgroundAdept:null,BackgroundNovice:null,BackgroundPthc1:null,BackgroundPthc2:null,BackgroundPthc3:null,Afflictions:null,Notes:"Discovered at Starter",Nature:"Adamant",SheetType:null,Hp:5,Atk:12,Def:8,Satk:6,
Sdef:13,Spd:4},target:{CharacterId:1,CampaignId:34,Type:"POKEMON",PokedexNo:"179",PokedexId:1,Name:"Phoebe",Owner:9,Age:null,Weight:null,Height:null,Sex:"Female",Type1:"Electric",Type2:null,Level:6,Exp:60,BaseHp:6,BaseAtk:4,BaseDef:4,BaseSatk:7,BaseSdef:5,BaseSpd:4,LvlUpHp:5,LvlUpAtk:2,LvlUpDef:2,LvlUpSatk:3,LvlUpSdef:2,LvlUpSpd:0,AddHp:0,AddAtk:0,AddDef:0,AddSatk:0,AddSdef:1,AddSpd:-1,Health:36,Injuries:0,Money:0,SkillAcrobatics:2,SkillAthletics:2,SkillCharm:2,SkillCombat:2,SkillCommand:2,SkillGeneralEd:2,
SkillMedicineEd:2,SkillOccultEd:2,SkillPokemonEd:2,SkillTechnologyEd:2,SkillFocus:2,SkillGuile:2,SkillIntimidate:2,SkillIntuition:2,SkillPerception:2,SkillStealth:2,SkillSurvival:2,ApSpent:0,ApBound:0,ApDrained:0,BackgroundName:null,BackgroundAdept:null,BackgroundNovice:null,BackgroundPthc1:null,BackgroundPthc2:null,BackgroundPthc3:null,Afflictions:null,Notes:"Discovered at Starter",Nature:"Sassy",SheetType:null,Hp:11,Atk:6,Def:6,Satk:10,Sdef:8,Spd:3},move:{Type:"Normal",Freq:"At-Will",AC:"4",DB:"4",
Class:"Physical",Range:"Melee, 1 Target","Crits On":20},acc:15,hit:!0,is_crit:!1,dmg_rolled:7,dmg_dealt:19,dmg_final:13},ActionHelper={evalPrereq:function(b){try{var a=eval(b.stmt);a instanceof Function&&(a=a());return b.val[a.toString().toLowerCase()]}catch(c){}}},ActionImpl={performMove:function(b,a,c,d){var e=d&&d.dmg_bonus?d.dmg_bonus:0,f=d&&d.acc_bonus?d.acc_bonus:0,h=CharacterHelper.fetchCharWithBuffs(c),g="other"!==a?CharacterHelper.fetchCharWithBuffs(a):null;"object"!==$.type(b)&&(b=getJSONNonAsync("api/v1/moves/"+
b));BattlerView.createMoveDialog(h,b.Title,b);d=0;d=!0;CurrentAction={dealer:h,target:g,move:b};AfflictionHelper.hasAffliction(c,"Paralysis")&&5>roll(1,20,1)&&(d=!1,doToast(h.Name+" is paralyzed! They can't move!"));d&&AfflictionHelper.hasAffliction(c,"Confused")&&(d=AfflictionHelper.handleAffliction("Confused",c));if(AfflictionHelper.hasAffliction(c,"Frozen"))doToast(h.Name+" is frozen solid!");else if(AfflictionHelper.hasAffliction(c,"Fainted"))doToast("Fainted Pokemon cannot use actions, abilities, or features");
else if(d){d=roll(1,20,1);var l=d+parseInt(f);addMoveDialogInfo("<strong>ACC:</strong> "+d+" + "+f);CurrentAction.acc=d+f;if(null!==g)if(f=Math.floor(g.Spd/5),l-=CharacterHelper.getEvadeBonus(a),"Physical"===b.Class){var k=Math.floor(g.Def/5);l-=f>k?f:k}else"Special"===b.Class?(k=Math.floor(g.Sdef/5),l-=f>k?f:k):l-=f;if(b.hasOwnProperty("AC")&&l<parseInt(b.AC))doToast("It missed!"),CurrentAction.hit=!1;else{CurrentAction.hit=!0;if("Physical"===b.Class||"Special"===b.Class){l=parseInt(b.DB);f=20<=
d;k=rollDamageBase(l,f?2:1);var m=0;addMoveDialogInfo("<strong>DMG:</strong> Rolled "+k+" on DB"+l);CurrentAction.is_crit=f;CurrentAction.dmg_rolled=k;20<=d&&doToast("Critical hit!");"Physical"===b.Class?m=k+h.Atk:"Special"===b.Class&&(m=k+h.Satk);m+=parseInt(e);CurrentAction.dmg_dealt=m;"other"===a?(doToast("OUTGOING DAMAGE = "+m),addMoveDialogInfo("<strong>OUTGOING DAMAGE:</strong> "+m),d=m):(d=this.damageCharacter(g,b.Type,"Special"===b.Class,m),addMoveDialogInfo("<strong>"+d+"</strong> total damage"));
CurrentAction.dmg_final=d}b.hasOwnProperty("Triggers")&&$.each(b.Triggers,function(a,b){ActionImpl.handleTrigger(b,h,g)})}}AfflictionHelper.hasAffliction(c,"Burned")&&AfflictionHelper.handleAffliction("Burned",c);AfflictionHelper.hasAffliction(c,"Frozen")&&AfflictionHelper.handleAffliction("Frozen",c)},damageCharacter:function(b,a,c,d){b&&"object"!==$.type(b)&&(b=CharacterHelper.fetchCharWithBuffs(b));d-=c?b.Sdef:b.Def;var e=c=1;a&&b.Type1&&(c=typeEffects[a.toLowerCase()][b.Type1.toLowerCase()],e=
b.Type2&&""!==b.Type2?typeEffects[a.toLowerCase()][b.Type2.toLowerCase()]:1);d=d*c*e;0===c*e?doToast("No effect!"):2<=c*e?doToast("It's super effective!"):1>c*e&&doToast("It's not very effective.");0>d&&(d=1);c=b.Level+3*b.Hp+10;d>=c/2&&(b.Injuries=parseInt(b.Injuries,10)+1);b.Health>c/2&&b.Health-d<=c/2&&(b.Injuries=parseInt(b.Injuries,10)+1);0<b.Health&&0>=b.Health-d&&(b.Injuries=parseInt(b.Injuries,10)+1);b.Health>-c/2&&b.Health-d<=-c/2&&(b.Injuries=parseInt(b.Injuries,10)+1);b.Health>-c&&b.Health-
d<=-c&&(b.Injuries=parseInt(b.Injuries,10)+1);b.Health>3*-c/2&&b.Health-d<=3*-c/2&&(b.Injuries=parseInt(b.Injuries,10)+1);c=Math.round((10-b.Injuries)/10*c);b.Health-=d;b.Health>c&&(b.Health=c);0>=b.Health&&(doToast(b.Name+" fainted!"),b.Health=0,AfflictionHelper.addAffliction("Fainted",b,0));CharacterHelper.updateCharData(b.CharacterId,{Health:b.Health,Injuries:b.Injuries},null);c=Math.floor(b.Health/c*100);$("[data-name='"+b.CharacterId+"']").find(".progress-bar").css("width",c+"%");"Fire"!==a&&
"Fighting"!==a&&"Rock"!==a&&"Steel"!==a||!AfflictionHelper.hasAffliction("Frozen",b.CharacterId)||AfflictionHelper.deleteAffliction("Frozen",b.CharacterId);return d},handleTrigger:function(b,a,c){c&&"object"!==$.type(c)&&(c=CharacterHelper.fetchCharWithBuffs(c));a&&"object"!==$.type(a)&&(a=CharacterHelper.fetchCharWithBuffs(a));if(b.hasOwnProperty("prereq"))"accuracy"===b.prereq&&b.req.hasOwnProperty(String(CurrentAction.acc))&&("object"===$.type(b.req[String(CurrentAction.acc)])?this.handleTrigger(b.req[String(CurrentAction.acc)],
a,c):this.handleTrigger(b.req[String(b.req[String(CurrentAction.acc)])],a,c));else{var d;b.hasOwnProperty("target")&&(d="SELF"===b.target?a:c);if("action-needed"===b.type)doToast(b.text),addMoveDialogInfo("<strong>MANUAL ACTION:</strong> "+b.text);else if("CS"===b.type)$.each(b.stat,function(a,c){CharacterHelper.modifyCombatStage(d.CharacterId,c,b.value);0<b.value?addMoveDialogInfo(d.Name+"'s <strong>"+c+"</strong> increased"):addMoveDialogInfo(d.Name+"'s <strong>"+c+"</strong> decreased")});else if("heal"===
b.type){a=b.value.split(" ");var e=d.Level+3*d.Hp+10;c="1/2"===a[0]?.5:parseInt(a[0],10);"HP"===a[1]?d.Health=Math.min(e*(10-d.Injuries)/10,d.Health+c*e):"Damage"===a[1]&&(d.Health=Math.min(e*(10-d.Injuries)/10,d.Health+c*CurrentAction.dmg_dealt));e=Math.floor(d.Health/e*100);$("[data-name='"+d.CharacterId+"']").find(".progress-bar").css("width",e+"%");CharacterHelper.updateCharData(d.CharacterId,{Health:d.Health,Injuries:d.Injuries},null);addMoveDialogInfo(d.Name+" <strong>was healed</strong>")}else"vortex"===
b.type?addMoveDialogInfo("<strong>Vortex</strong> has yet to be implemented"):"push"===b.type?addMoveDialogInfo("<strong>Push</strong> has yet to be implemented"):"switch"===b.type?addMoveDialogInfo("<strong>Switch</strong> has yet to be implemented"):"status"===b.type?$.each(b.stat,function(a,b){AfflictionHelper.addAffliction(b,d,0)}):"damage"===b.type?(e=d.Level+3*d.Hp+10,"number"===typeof b.value?a=b.value:"User Level"===b.value?a=a.Level:(a=b.value.split(" ")[0].split("/"),a=e*parseInt(a[0],10)/
parseInt(a[1],10)),c.Health>e/2&&c.Health-damage<=e/2&&(c.Injuries=parseInt(c.Injuries,10)+1),0<c.Health&&0>=c.Health-damage&&(c.Injuries=parseInt(c.Injuries,10)+1),c.Health>-e/2&&c.Health-damage<=-e/2&&(c.Injuries=parseInt(c.Injuries,10)+1),c.Health>-e&&c.Health-damage<=-e&&(c.Injuries=parseInt(c.Injuries,10)+1),c.Health>3*-e/2&&c.Health-damage<=3*-e/2&&(c.Injuries=parseInt(c.Injuries,10)+1),d.Health=Math.min(d.Health-a,e*(10-d.Injuries)/10),e=Math.floor(d.Health/e*100),$("[data-name='"+d.CharacterId+
"']").find(".progress-bar").css("width",e+"%"),CharacterHelper.updateCharData(d.CharacterId,{Health:d.Health,Injuries:d.Injuries},null)):"protect"===b.type?addMoveDialogInfo("<strong>Protect/Interrupt</strong> has yet to be implemented"):"execute"===b.type&&(roll(1,100,1)<=30+gm_data.pokemon[dealer_id].level-c.level?(doToast(d.Name+" fainted!"),CharacterHelper.updateCharData(d.CharacterId,{Health:0},null),AfflictionHelper.addAffliction("Fainted",d,0)):doToast(CurrentAction.move.Name+" missed "+c.name+
"!"))}}};function getStatByAction(b,a,c){a="TARGET"===c?a.target:a.dealer;switch(b){case "HP":return a.BaseHp+a.AddHp+a.LvlUpHp;case "ATK":return a.BaseAtk+a.AddAtk+a.LvlUpAtk;case "DEF":return a.BaseDef+a.AddDef+a.LvlUpDef;case "SATK":return a.BaseSatk+a.AddSatk+a.LvlUpSatk;case "SDEF":return a.BaseSdef+a.AddSdef+a.LvlUpSdef;case "SPD":return a.BaseSpd+a.AddSpd+a.LvlUpSpd;default:return 0}}function startBattle(){in_battle={}}
function endBattle(){window.confirm("Are you sure you want to reset the battle?")&&($.each(in_battle,function(b,a){sendMessage(a,JSON.stringify({type:"battle_end"}))}),in_battle={},BattlerView.render())}
function doGMDataConvert_v1_v2(){gm_data.entities={};$.each(gm_data.pokemon,function(b,a){a.entity_type="POKEMON";a.hp=[a.hp];a.health=[a.health];a.atk=[a.atk];a.def=[a.def];a.spatk=[a.spatk];a.spdef=[a.spdef];a.speed=[a.speed];a.notes_discovery=a.discovery;a.type=a.type.split("/");delete a.afflictions;delete a.discovery;gm_data.entities[b]=a})};var BattlerView={render:function(){if(0===currentView){var b=[],a="";$.isEmptyObject(battle)?a='<h3 class="text-muted">No one\'s here yet \ud83d\ude1f</h3><h4 class="text-muted">Send your <a data-toggle="modal" data-target="#modalShare">customized link</a> to your players. Then, have them hit "Join Battle" when they\'re ready.</h4>':($.each(battle,function(a,d){var c=gm_data.pokemon[a].level+3*gm_data.pokemon[a].hp+10,f=Math.floor(gm_data.pokemon[a].health/c*100),h=gm_data.pokemon[a].injuries;100<
f&&console.log("Warning: Pokemon with ID "+a+" has hit points above its max: "+gm_data.pokemon[a].health+"/"+c);var g="";null!=gm_data.pokemon[a].afflictions&&$.each(gm_data.pokemon[a].afflictions,function(a,b){g+=' <span class="label label-danger">'+b+"</span>"});null!=d.afflictions&&$.each(d.afflictions,function(a,b){g+=' <span class="label label-danger">'+a+"</span>"});d=0;for(c=gm_data.pokemon[a].speed*getStageMultiplier(battle[a].stage_speed);d<b.length&&!(c>b[d].speed);)d++;b.splice(d,0,{html:'<div class="col-md-6 col-md-offset-3 pokemon" data-name="'+
a+'"><h2 class="name">'+gm_data.pokemon[a].name+g+'</h2><div class="progress" data-hp="'+gm_data.pokemon[a].hp+'" data-max-hp="'+gm_data.pokemon[a].max_hp+'"><div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="'+f+'" aria-valuemin="0" aria-valuemax="100" style="width: '+f+'%;"></div><div class="progress-bar progress-bar-injuries pull-right" role="progressbar" aria-valuenow="'+h+'0" aria-valuemin="0" aria-valuemax="100" style="width: '+h+'0%;"></div></div></div>',speed:c})}),
$.each(b,function(b,d){a+=d.html}),a+='<br/><button class="btn btn-danger btn-raised" onclick="endBattle()">End Battle</button>');$("#tab-battle-list").html(a)}},createMoveDialog:function(b,a,c){0!==currentView&&doToast(b.Name+" used "+a+"!");b='<img src="img/pokemon/'+b.PokedexNo+'.gif" /><div class="battle-dialog"><p>'+b.Name+' used <span style="color:'+typeColor(c.Type)+'">'+a+"</span></p></div>";$("#battle-message").html(b)},addMoveDialogInfo:function(b){$(".battle-dialog").append("<p><strong>&gt;</strong> "+
b+"</p>")}},CharacterView={renderCharacterList:function(){$.getJSON("api/v1/data/character/list",{campaign_id:34},function(b){var a=$(".list-pokemon").html("");$.each(b,function(b,d){b='<img class="img-circle pull-left bg-danger" height="60px" width="60px" />';"POKEMON"===d.type&&(b='<img src="img/pokemon-profiles/'+d.dex+'.png" class="img-circle pull-left bg-danger" height="60px" width="60px" />');a.append('<div class="char-entry char-owner col-sm-6">'+b+'<div class="btn-group-vertical pull-right"><button onclick="onClickEditCharacter(\''+
d.id+'\')" class="btn btn-info btn-xs"><i class="material-icons">edit</i></button><button onclick="onClickDeletePokemon(\''+d.id+'\')" class="btn btn-danger btn-xs"><i class="material-icons">delete</i></button></div><span class="char-name">'+d.name+"</span></div>");$.each(d.owned,function(b,c){b='<img class="img-circle pull-left bg-danger" height="60px" width="60px" />';"POKEMON"===c.type&&(b='<img src="img/pokemon-profiles/'+c.dex+'.png" class="img-circle pull-left bg-danger" height="60px" width="60px" />');
a.append('<div class="char-entry col-sm-6">'+b+'<div class="btn-group-vertical pull-right"><button onclick="onClickEditCharacter(\''+c.id+'\')" class="btn btn-info btn-xs"><i class="material-icons">edit</i></button><button onclick="onClickDeletePokemon(\''+c.id+'\')" class="btn btn-danger btn-xs"><i class="material-icons">delete</i></button></div><span class="char-name">'+c.name+"</span></div>")});a.append("<hr/>")})})},onClickEditCharacter:function(b){createCharacterEditor(b,"#tab-char-io");changeView(1,
!0);$('a[href="#tab-char-io"]').tab("show")}};function saveGM(){var b="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(gm_data)),a=document.getElementById("downloadAnchor");a.setAttribute("href",b);a.setAttribute("download","GMData.json");a.click();firebase.auth()}function fetchCharacterById(b,a){$.getJSON("api/v1/data/character/"+b,a)}function fetchCharactersByCampaignId(b,a){$.getJSON("api/v1/data/character/list/?campaign_id="+b,a)}
function fetchCharacterMoves(b,a){$.getJSON("/api/v1/data/character/moves/?character_id="+b,a)}function fetchPage(b,a){$.get("/pages/"+b+".php",a)}function createCharacterEditor(b,a){$.get("/pages/char-edit.php",{id:b},function(b){$(a).html(b)})}function getJSONNonAsync(b){var a;$.ajax({type:"GET",url:b,dataType:"json",async:!1,success:function(b){a=b}});return a}function getJSONNonAsync(b,a){var c;$.ajax({type:"GET",url:b,dataType:"json",async:!1,data:a,success:function(a){c=a}});return c};var connectionMap={};peer.on("connection",function(b){b.on("open",function(){receiveMessages(b,GMPeer.readMessage);b.send(JSON.stringify({type:"pokemon_list",pokemon:gm_data.pokemon}))})});
var GMPeer=function(){return{reconnect:function(){peer.reconnect()},readMessage:function(b,a){a=JSON.parse(a);if("alert"===a.type)doToast(a.content);else if("pokemon_get"==a.type)b.send(JSON.stringify({type:"pokemon",pokemon:gm_data.pokemon[a.pokemon_id]}));else if("pokemon_list"==a.type)b.send(JSON.stringify({type:"pokemon_list",pokemon:gm_data.entities}));else if("battle_add"===a.type)$.post("api/v1/battle/join",{character_id:a.character_id},function(a){"false"===a?b.send({type:"alert",content:"Already in battle"}):
alert(a)}),connections[a.character_id]=a.from,in_battle.push(a.character_id),b.send(JSON.stringify({type:"battle_added",pokemon_id:a.character_id})),doToast(gm_data.entities[a.pokemon].name+" Appears!"),BattlerView.render();else if("pokemon_update"==a.type)gm_data.entities[a.pokemon][a.field][0]=a.value,"health"===this.field&&(gm_data.entities[a.pokemon].health[0]=a.value);else if("pokemon_setcs"==a.type)battle[a.pokemon][a.field]=a.value;else if("pokemon_afflict_add"==a.type)AfflictionHelper.addAffliction(a.affliction,
a.pokemon,a.value);else if("pokemon_afflict_delete"==a.type)AfflictionHelper.deleteAffliction(a.affliction,a.pokemon);else if("pokemon_afflict_trigger"==a.type)AfflictionHelper.handleAffliction(a.affliction,a.pokemon);else if("battle_grid"==a.type){a=a.max_width/parseInt($("#grid-w").val())-2;var c=$("<div />");c.ready_callback=function(){b.send(JSON.stringify({type:"battle_grid",html:c.html()}))};generateGrid(c,a)}else if("battle_move"==a.type)ActionImpl.performMove(a.move,a.target,a.dealer,a.bonus_acc,
a.bonus_dmg);else if("battle_damage"==a.type){var d=$.get("api/v1/data/character/"+a.target);ActionImpl.damageCharacter(d,a.moveType,a.isSpecial,a.damage)}else"status"==a.type&&b.send(JSON.stringify({type:"gm_status",value:"online"}))}}}();
